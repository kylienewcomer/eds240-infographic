---
title: "drafting-viz"
author: "Kylie Newcomer"
format: html
execute:
  warning: false
  message: false
---

## Initial Questions

1.  Restate the questions you hope to answer with your infographic. This should include one overarching question (think of this as driving the overall theme of your infographic) and at least three subquestions (each of which will be addressed by your infographic’s component visualizations). Have these questions changed at all since FPM #1? If yes, how so?

**How does kelp density affect the fish communities in the Channel Islands?**

-   How does varying kelp density affect fish taxa proportions?

-   How does biodiversity through the water column change with kelp density?

-   Does higher kelp density increase "rare" fish sightings?

2.  Explain which variables from your data set(s) you will use to answer the above questions, and how. To address all of my questions, I will utilizing the `cnpy_pct` variable which represents the estimated percent of kelp in a survey transect, with the values further binned into 10% margins. Additionally, I will be utilizing the variables `classcode` which denotes individual species, as well as `family` to assess broader taxanomic influences. I will be utilizing the `count` variable which represents the number of a fish species observed in a given size range.

3.  In FPM #2, you created some exploratory data viz to better understand your data. You may already have some ideas of how you plan to formally visualize your data, but it’s incredibly helpful to look at visualizations by other creators for inspiration. Find at least two data visualizations that you could (potentially) borrow / adapt pieces from. Download and embed them into your drafting-viz.qmd file, and explain which elements you might borrow (e.g. the graphic form, legend design, layout, etc.).

![](images/biodiv_ex.jpg) I like the idea how number of species is mapped out, however, instead I would want to "map" out the diversity through the water column. The idea would be to take a slice of the water column at across densities of kelp and visualizing biodiversity.

![](images/raresp-fig.png) I like how this figure displays observations of species. I would like to create something similar but instead of observation types, I would look at greater than or less than 50% kelp density. I also like how the silhouettes of fish are shown and would like to include that in my final figure. My issue now is how I will select rare species that have enough observations that I could make something similar.

## ![](images/IMG_0386.jpg)Hand drawn visualizations

```{r}
library(tidyverse)
library(here)
library(vegan)

subtidal <- read_csv(here("data", "ucsb_fish_clean_obs_1999-2024.csv"))
taxon <- read_csv(here("data", "PISCO_kelpforest_taxon_table.1.3.csv")) %>% 
  filter(campus == "UCSB")

fish_taxon <- left_join(subtidal, taxon, by = "classcode") %>% 
  select(year, site, side, zone, level, transect, classcode, fish_tl, depth, pctcnpy, count, Family, Genus, Species, common_name) %>% 
  janitor::clean_names()

fish_role <- read_csv(here("data", "ucsb_fish_clean_tx_bm_1999-2024.csv")) %>% 
  filter(year > 2005) %>% 
  select(classcode, BroadTrophic, Targeted) %>%
  distinct() %>%
  group_by(classcode) %>% 
  summarise(BroadTrophic = paste(BroadTrophic, collapse = ", "),
            Targeted = paste(Targeted, collapse = ", "),
    .groups = 'drop') %>% 
  janitor::clean_names()


fish <- left_join(fish_taxon, fish_role, by = "classcode") %>% 
  janitor::clean_names()

```

```{r}
fish_clean <- fish %>% 
  filter(!is.na(fish_tl)) %>%
  group_by(site) %>% 
  mutate(total_years = length(unique(year))) %>% # Calculate number of years each site was surveyed
  ungroup() %>%
  mutate(island = case_when( # Assign sites to respective islands
    str_detect(pattern = "SRI", string = site) ~ "Santa Rosa", 
    str_detect(pattern = "SCI", string = site) ~ "Santa Cruz",
    str_detect(pattern = "SMI", string = site) ~ "San Miguel",
    str_detect(pattern = "ANA", string = site) ~ "Anacapa",
    TRUE ~ "remove"), 
    level = factor(level, levels = c("CAN", "MID", "BOT"))) %>% # Refactor survey levels
  filter(island != "remove", 
         total_years >= 15,
         year > 2005) %>% # Select only sites with >=15 years of surveys
  select(-total_years)
```

```{r}
# Calculate canopy averages at transect level
kelp <- fish_clean %>% 
  group_by(site, side, transect, year) %>% 
  summarise(av_pctcnpy = round(mean(pctcnpy, na.rm = TRUE), digits = 0)) %>% 
  ungroup() %>%
  mutate(cnpy_pct = case_when( # Bin percent canopy cover
    av_pctcnpy <= 10 ~ "0-10",
    av_pctcnpy <= 20 ~ "11-20",
    av_pctcnpy <= 30 ~ "21-30",
    av_pctcnpy <= 40 ~ "31-40",
    av_pctcnpy <= 50 ~ "41-50",
    av_pctcnpy <= 60 ~ "51-60",
    av_pctcnpy <= 70 ~ "61-70",
    av_pctcnpy <= 80 ~ "71-80",
    av_pctcnpy <= 90 ~ "81-90",
    av_pctcnpy > 90 ~ "91-100",
    TRUE ~ NA,
    )
  ) %>% 
  filter(!is.na(cnpy_pct))

fish_kelp <- left_join(fish_clean, kelp, by = join_by(site, side, transect, year)) # Attach bins to data

```

```{r}
species_sums <- fish_kelp %>% 
  group_by(family) %>% 
  mutate(total_obs = n(),
         total_counts = sum(count)) %>% 
  ungroup() %>% 
  mutate(fish_family = case_when(
    total_counts >= 30000 ~ family,
    TRUE ~ "Other"))
```

```{r}
# Color palettes
plot_palette = c("#001806", "#7F6F2B", "#9A7408", "#D4C569", "#AA9D52", "#EBF4F2", "#B6E5F0", "#96B8A9", "#1E6848", "#004B5D", "#002B2B")
fish = c("#8C6E56", "#CFCDCB", "#F7CE7B", "#E38023", "#F15739", "#823E57", "#4761B4")
```

```{r}
species_sums$fish_family <- factor(species_sums$fish_family, 
                                   levels = c("Atherinopsidae", "Embiotocidae", "Labridae", "Pomacentridae", "Sebastidae", "Serranidae", "Other"), 
                                   labels = c("Baitfish", "Surfperch", "Wrasses", "Damselfish", "Rockfish", "Basses", "Other"))

level_labs <- c(CAN = "Canopy", 
                MID = "Midwater", 
                BOT = "Bottom")
```

```{r}
#species_fig <- 
  species_sums %>% 
  #filter(island == "Anacapa") %>%
  group_by(cnpy_pct, level) %>% 
  summarize(total_fish = sum(count),
            mean_obs = mean(count),
            unique_species = length(unique(classcode))) %>%
  ungroup() %>% 
  #mutate(cnpy_pct = as.factor(cnpy_pct, 0.3)) %>% 
  filter(total_fish >= 20) %>% 
  ggplot() +
  geom_col(aes(cnpy_pct, unique_species, alpha = cnpy_pct), fill = "#D4C569", color = NA, show.legend = FALSE) +
  #geom_jitter(aes(cnpy_pct, unique_species, color = fish_family, size = total_fish), alpha = 0.9) +
  #theme(legend.position = "none") +
  scale_color_manual(values = fish) +
  #scale_alpha_discrete(range = c(0.2,1)) + 
  facet_wrap(~level, 
             #scales = "free", 
             ncol = 1, 
             labeller = labeller(level = level_labs)) +
  theme_light() +
  theme(panel.background = element_rect(fill = "#002B2B"), 
        panel.grid.major = element_line(linewidth = 0),
        panel.grid.minor = element_line(linewidth = 0),
        legend.background = element_rect(fill = NA),
        legend.box.background = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(color = "#002B2B", size = 12),) +
  labs(x = "Kelp Density (%)",
       y = "Number of observed species",
       #color = "Family",
       #size = "Total observed fish",
       title = "Fish diversity through the water column under varying kelp density")

```

```{r}

ggplot(species_sums, aes(cnpy_pct, count, fill = fish_family)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = fish) +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "",
       x = "Percent Kelp Canopy Cover",
       title = "Proportion of Fish Families Under Varying Densities of Kelp Canopy",
       fill = "Family") +
  facet_wrap(~level, ncol = 1) +
  theme_light()
```

```{r}
library(ggExtra)

fish_kelp %>% 
  mutate(depth_ft = round(depth * 3.28084, digits = 0), # convert depth from meters to feet
    depth_zone = case_when(
      depth_ft <= 10 ~ "0-10",
      depth_ft <= 20 ~ "11-20",
      depth_ft <= 30 ~ "21-30",
      depth_ft <= 40 ~ "31-40",
      depth_ft <= 50 ~ "41-50",
      depth_ft > 50 ~ ">50",
      TRUE ~ NA
  )) %>% 
  filter(!is.na(depth_zone)) %>% 
  mutate(depth_zone = forcats::fct_relevel(depth_zone,
         ">50", "41-50", "31-40", "21-30", "11-20", "0-10")) %>% 
  group_by(cnpy_pct, depth_zone, classcode) %>% 
  summarise(num_sp = sum(count),
         n = num_sp*(num_sp-1)) %>% 
  ungroup() %>% 
  group_by(cnpy_pct, depth_zone,) %>% 
  summarize(total_indiv = sum(num_sp),
         N = total_indiv*(total_indiv-1),
         biodiv = N / sum(n)) %>% 
  filter(!is.infinite(biodiv)) %>%
      #av_species = mean(length(unique(classcode)), rm.na = TRUE)) %>% 
  ggplot(aes(cnpy_pct, depth_zone, fill = biodiv)) +
  geom_tile() +
  scale_fill_gradient(high = "#002B2B", low = "#D4C569") +
  labs(x = "Kelp Density (%)",
       y = "Depth zone (ft)",
       fill = "Biodiversity\nIndex",
       title = "Biodiversity through the water column") +
  scale_x_discrete(expand = c(0, 0)) + # Remove dead space
  scale_y_discrete(expand = c(0, 0)) +
  theme_light() +
  theme(panel.background = element_rect(fill = "#EBF4F2"),
        plot.background = element_rect(fill = "#EBF4F2"),
        legend.background = element_rect(fill = "#EBF4F2"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(color = "#001806"))
```



```{r}
rare_sp <- fish_kelp %>% 
  filter(classcode != "BAITBALL" & 
         classcode != "RFYOY" &
         classcode != "UNID" &
         classcode != "SCARSCAU" &
         classcode != "OYB") %>% 
  group_by(classcode) %>% 
  summarize(total_obs = n(),
         total_counts = sum(count)) %>% 
  filter(total_obs >= 5) %>% 
  slice_min(total_obs, n = 15) %>% 
  ungroup()


fish_kelp %>% 
  filter(classcode %in% rare_sp$classcode) %>% 
  mutate(kelp_dens = case_when(
    av_pctcnpy < 50 ~ "less_kelp",
    TRUE ~ "more_kelp"
  )) %>% 
  group_by(common_name, kelp_dens) %>% 
  summarize(total_obs = n()) %>% 
  ungroup() %>% 
  ggplot() +
  geom_point(aes(total_obs, common_name, color = kelp_dens)) +
  scale_color_manual(labels = c("<50% kelp density", ">50% kelp density"), values = c( "#B6E5F0", "#004B5D")) +
  labs(color = "",
       x = "Number of observations",
       y = "",
       title = "Observations of rare species") +
  theme_light() +
  theme(panel.background = element_rect(fill = "#EBF4F2"),
        plot.background = element_rect(fill = "#EBF4F2"),
        legend.background = element_rect(fill = "#EBF4F2"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(color = "#001806"))
```

## Final Questions

1.  What are the key insights you want your infographic to communicate, and how will your design choices help highlight and support those messages?

I want my infographic to communicate the relationship between and robust kelp forest and the fish communities that it's home to. I will aim to highlight increases in biodiversity at higher kelp densities. I want the viewer to be able to imagine what the makeup of the fish community would be at a given depth and kelp density.

2.  What challenges did you encounter or anticipate encountering as you continue to build / iterate on your visualizations in R? If you struggled with mocking up any of your three visualizations, describe those challenges here.

The first challenge I am anticipating is that my visualizations do not show the trends I am predicting. I had trouble creating my rare species figure, and did not have enough time to complete it. I read that I need to create a diverging column figure, but was unable to create one that looked how I would like it to. 

3.  What ggplot extension tools / packages do you need to use to build your visualizations? Are there any that we haven’t covered in class that you’ll be learning how to use for your visualizations?

I am contemplating using ggextra to add a distribution to the margins. I am also debating on incorporating ggimage to use photos of fish as my points. This is an extension I've been experimenting with in my capstone, so I have a decent understanding of how to use it.

4.  What feedback do you need from the instructional team and / or your peers to ensure that your intended message and key insights are clear?

I would like constructive criticism on my figures. Whether its the right figure type or just stylistic choices that I am making that are portraying the message that I want to portray.
